{"version":3,"sources":["meteor://üíªapp/lib/routers/shop.js"],"names":[],"mappings":"sBAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,G","file":"/lib/routers/shop.js","sourcesContent":["/* SHOP */\n\nRouter.route(\"/shop\", {\n\tcontroller : \"CleanController\",\n\tname: \"shop.index\",\n\taction : function () {\n\t\tSession.set(Meteor.PAGE_TITLE, \"Liste des Magasins/Clients\");\n\t\tthis.render(\"shopindex\");\n\t\tif(Meteor.isBoss()){\n\t\t\tSession.set(Meteor.FILL_CONTEXT_MENU_KEY, true);\n\t\t\tthis.render(\"shopaction\", {to : \"action\"}); //contextmenu.action\n\t\t}\n\t},\n\tdata : function(){\n\t\tvar skip = parseInt(this.params.query.skip) || Meteor.indexSkip;\n\t\tvar limit = parseInt(this.params.query.limit) || Meteor.indexLimit;\n\t\tvar where = this.params.query.where || {};\n\n\t\tif(_.isString(where)){\n\t\t\twhere = where.toLowerCase();\n\t\t\twhere = where.replace(/\\.|\\\\|\\+|\\*|\\?|\\[|\\^|\\]|\\$|\\(|\\)|\\{|\\}|\\=|\\!|\\>|\\||\\:|\\-/g, \"\");\n\t\t\twhere = {\n\t\t\t\t$or : [{\n\t\t\t\t\tname : {\n\t\t\t\t\t\t$regex : \".*\"+where+\".*\"\n\t\t\t\t\t}\n\t\t\t\t}, {\n\t\t\t\t\tbrand : {\n\t\t\t\t\t\t$regex : \".*\"+where+\".*\"\n\t\t\t\t\t}\n\t\t\t\t}]\n\t\t\t};\n\t\t}\n\t\t\n\t\treturn {\n\t\t\tshops : Shops.find(where,{\n\t\t\t\tskip: skip,\n\t\t\t\tlimit: limit,\n\t\t\t\tsort : {\n\t\t\t\t\tbrand : 1\n\t\t\t\t} \n\t\t\t}),\n\t\t\tcount : Shops.find(where).count(),\n\t\t\twhere : this.params.query.where||\"\",\n\t\t\tlimit : limit,\n\t\t\tskip : skip\n\t\t};\n\t}\n});\n\n\n\nRouter.route(\"/shop/new\", {\n\tcontroller : \"ApplicationController\",\n\tname: \"shop.new\",\n\taction : function () {\n\t\tSession.set(Meteor.PAGE_TITLE, \"Cr√©er un nouveau Magasins/Clients\");\t\n\t\tthis.render(\"shopnew\");\n\t}\n});\n\n\n\nRouter.route(\"/shop/edit/:shopId\", {\n\tcontroller : \"CleanController\",\n\tname: \"shop.edit\",\n\tdata : function(){\n\t\treturn Shops.findOne(this.params.shopId); \n\t},\n\taction : function () {\n\t\tvar data = this.data();\n\t\tif(data){\n\t\t\tSession.set(Meteor.PAGE_TITLE, \"Edition \"+s.capitalize(data.name)+\" - \"+s.capitalize(data.brand));\t\n\t\t}\n\t\tthis.render(\"shopedit\");\n\t\tif(Meteor.isBoss()){\n\t\t\tSession.set(Meteor.FILL_CONTEXT_MENU_KEY, true);\n\t\t\tthis.render(\"shopeditaction\", {to : \"action\"}); //contextmenu.action\n\t\t}\n\t}\n});\n\n\n\nRouter.route(\"/shop/:shopId\", {\n\tcontroller : \"ApplicationController\",\n\tname: \"shop.view\",\n\tdata : function(){\n\t\tvar date = moment(this.params.query.date || Session.get(Meteor.CALENDAR_CONF).defaultDate);\n\t\tdate = moment([date.year(), date.month()]);\n\n\n\t\tSession.set(Meteor.DATE_CONF, date.format());\n\t\t\n\t\tvar where = {\n\t\t\t\"shop._id\" : this.params.shopId, \n\t\t\trdv : {\n\t\t\t\t$gte: date.toISOString(),\n\t\t\t\t$lte: date.endOf('month').toISOString()\n\t\t\t}\n\t\t};\n\t\tvar tmp = \t_\n\t\t\t\t\t.chain(\n\t\t\t\t\t\tWorks\n\t\t\t\t\t\t.find(where, {\n\t\t\t\t\t\t\tsort : {\n\t\t\t\t\t\t\t\trdv : -1\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.fetch()\n\t\t\t\t\t)\n\t\t\t\t\t.map(function(work){\n\t\t\t\t\t\twork.rdv = moment(work.rdv).format(\"dd DD MMM HH:mm\");//.format(\"DD/MM/YY HH:mm\");\n\t\t\t\t\t\treturn work;\n\t\t\t\t\t})\n\t\t\t\t\t.groupBy(function(work){\n\t\t\t\t\t\treturn work.end;\n\t\t\t\t\t})\n\t\t\t\t\t.value();\n\t\tvar unfinished = tmp.undefined || [];\n\t\tvar torun = [];\n\t\tunfinished = \tunfinished\n\t\t\t\t\t\t.map(function(work){\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\tif( _\n\t\t\t\t\t\t\t\t.chain(work.schedular)\n\t\t\t\t\t\t\t\t.keys()\n\t\t\t\t\t\t\t\t.map(function(worker){\n\t\t\t\t\t\t\t\t\treturn  work.schedular[worker].length > 0;\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t.some()\n\t\t\t\t\t\t\t\t.value()\n\t\t\t\t\t\t\t){\n\t\t\t\t\t\t\t\treturn work;\n\t\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\t\ttorun.push(work);\n\t\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\tunfinished = _.compact(unfinished)\n\n\t\tdelete tmp.undefined;\t\t\n\t\treturn{\n\t\t\tworks : {\n\t\t\t\tcount : Works.find(where).count(),\n\t\t\t\tdate : date,\n\t\t\t\ttorun : torun.reverse(),\n\t\t\t\tunfinished : unfinished,\n\t\t\t\tfinished : \t_\n\t\t\t\t\t\t\t.chain(tmp)\n\t\t\t\t\t\t\t.values()\n\t\t\t\t\t\t\t.flatten()\n\t\t\t\t\t\t\t.map(function(work){\n\t\t\t\t\t\t\t\twork.depannage = work.type == \"d√©pannage\";\n\t\t\t\t\t\t\t\twork.installation = work.type == \"installation\";\n\t\t\t\t\t\t\t\twork.entretien = work.type == \"maintenance\";\n\t\t\t\t\t\t\t\treturn work;\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t.value()\n\t\t\t},\n\t\t\tshop : Shops.findOne(this.params.shopId)\n\t\t};\n\t},\n\taction : function () {\n\t\tvar data = this.data();\n\t\tif(data){\n\t\t\tSession.set(Meteor.PAGE_TITLE, s.capitalize(data.shop.name)+\" - \"+s.capitalize(data.shop.brand));\t\n\t\t}\n\t\tthis.render(\"shopview\");\n\t}\n});\n\n\n\nRouter.route(\"/shop/modules/:shopId\", {\n\tcontroller : \"ApplicationController\",\n\tname: \"shop.modules\",\n\tdata : function(){\n\t\tvar shopId = this.params.shopId;\n\t\treturn {\n\t\t\tshop : Shops.findOne(shopId),\n\t\t\tmodules : \tModules\n\t\t\t\t\t\t.find({}, {\n\t\t\t\t\t\t\tsort : {\n\t\t\t\t\t\t\t\ttype : 1\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.fetch()\n\t\t\t\t\t\t.map(function(module){\n\t\t\t\t\t\t\tmodule.shopId = shopId;\n\t\t\t\t\t\t\treturn module;\n\t\t\t\t\t\t})\n\t\t};\n\t},\n\taction : function () {\n\t\tvar data = this.data();\n\t\tif(data && data.shop){\n\t\t\tSession.set(Meteor.PAGE_TITLE, \"Edition des modules de \"+s.capitalize(data.shop.name)+\" - \"+s.capitalize(data.shop.brand));\t\n\t\t}\n\t\tthis.render(\"shopmodules\");\n\t}\n});"]}