{"version":3,"sources":["meteor://ðŸ’»app/lib/methods/workers.js"],"names":[],"mappings":"yBAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,G","file":"/lib/methods/workers.js","sourcesContent":["\"use strict\";\n/*global _ : false */\n/*global $ : false */\n/*global Npm : false */\n/*global HTTP : false */\n/*global Email : false */\n/*global Works : false */\n/*global Router : false */\n/*global Meteor : false */\n/*global Workers : false */\n/*global Accounts : false */\n\n\nMeteor.methods({\n\tworkerUpdator: function (workerid, worker) {\n\t\t// Make sure the user is logged in before inserting a task\n\t\tif (! Meteor.userId()) {\n\t\t\treturn new Meteor.Error(\"not-authorized\");\n\t\t}\n\t\tthis.unblock();\n\t\treturn Workers.update(workerid, {$set : {profile : worker}});\n\t},\n\tworkerDestroyer: function (workerid) {\n\t\t// Make sure the user is logged in before inserting a task\n\t\tif (! Meteor.userId()) {\n\t\t\treturn new Meteor.Error(\"not-authorized\");\n\t\t}\n\t\tthis.unblock();\n\t\treturn Workers.remove(workerid);\n\t},\n\tworkerCreator: function (worker, button) {\n\t\t// Make sure the user is logged in before inserting a task\n\t\tif (! Meteor.userId()) {\n\t\t\treturn new Meteor.Error(\"not-authorized\");\n\t\t}\n\t\tthis.unblock();\n\n\t\tif(Meteor.isServer){\n\t\t\tvar Future = Npm.require(\"fibers/future\");\n\t\t\tvar myFuture = new Future();\n\t\t\tvar url = \"https://passwordwolf.com/api/?upper=off&special=off&length=10&repeat=1\";\n\n\n\n\t\t\tHTTP.get(url, {\n\t\t\t\tfollowRedirects : true\n\t\t\t}, function (error, result) {\n\t\t\t\tif(error) myFuture.throw(error);\n\t\t\t\tif(result.statusCode != 200) myFuture.throw(new Meteor.Error(\"statusCode-\"+result.statusCode));\n\t\t\t\ttry{\n\t\t\t\t\tvar body = JSON.parse(result.content);\n\t\t\t\t\tworker.password = body[0].password;\n\n\t\t\t\t\tvar account = Accounts.createUser(worker);\n\n\t\t\t\t\tEmail.send({\n\t\t\t\t\t\tto: worker.email,\n\t\t\t\t\t\tfrom: \"robot@taf.com\",\n\t\t\t\t\t\tsubject: \"Welcom on TAF\",\n\t\t\t\t\t\ttext: \"GO and connect on TAF. email : \"+worker.email+\" password : \"+worker.password\n\t\t\t\t\t});\n\n\t\t\t\t\tmyFuture.return(account);\n\t\t\t\t}catch(e){\n\t\t\t\t\tmyFuture.throw(new Meteor.Error(\"statusCode-\"+result.statusCode));\n\t\t\t\t}\n\t\t\t});\n\t\t\treturn myFuture.wait();\n\t\t}\n\t\t\n\t\tif(this.isSimulation){\n\t\t\t$(button)\n\t\t\t.removeClass(\"btn-primary\")\n\t\t\t.addClass(\"btn-success\");\n\t\t\tRouter.go(\"home\");\n\t\t}\n\t},\n\tworkerSchedule : function( workId, workerId, action, datetime){\n\t\tthis.unblock();\n\t\t//STOP WORKER WORKING AT ANY WORK \n\t\tWorks\n\t\t.find({\n\t\t\t$where : function(){\n\t\t\t\treturn _.find(this.schedular[workerId], function(schedule){\n\t\t\t\t\treturn schedule.start && !schedule.stop;\n\t\t\t\t});\n\t\t\t}\n\t\t})\n\t\t.fetch()\n\t\t.map(function(work){\n\t\t\tvar schedular = work.schedular || {};\n\t\t\tschedular[workerId] = schedular[workerId] ||Â [];\n\t\t\tschedular[workerId] =\tschedular[workerId]\n\t\t\t\t\t\t\t\t\t.map(function(schedule){\n\t\t\t\t\t\t\t\t\t\tschedule.stop = schedule.stop ||Â datetime;\n\t\t\t\t\t\t\t\t\t\treturn schedule;\n\t\t\t\t\t\t\t\t\t});\n\t\t\tWorks\n\t\t\t.update(work._id, {\n\t\t\t\t$set : {\n\t\t\t\t\tschedular : schedular\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t\t\n\t\t//START WORKER WORKING\n\t\tvar work = Works.findOne(workId);\n\t\tvar schedular = work.schedular || {};\n\t\tschedular[workerId] = schedular[workerId] ||Â [];\n\t\tif(action === \"start\"){\n\t\t\tschedular[workerId].push({\n\t\t\t\tstart : datetime\n\t\t\t});\n\t\t}\n\n\t\tWorkers.update(workerId, {\n\t\t\t$set : {\n\t\t\t\tworking : (action === \"start\")\n\t\t\t}\n\t\t});\n\t\treturn Works.update(workId, {$set : {schedular : schedular}});\n\t}\n});"]}