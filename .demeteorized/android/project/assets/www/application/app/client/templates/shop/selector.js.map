{"version":3,"sources":["meteor://ðŸ’»app/client/templates/shop/selector.js"],"names":[],"mappings":"yBAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,G","file":"/client/templates/shop/selector.js","sourcesContent":["\"use strict\";\n/*global $ : false */\n/*global Shops : false */\n/*global Meteor : false */\n/*global Session : false */\n/*global Template : false */\n\n\nTemplate.shopselector.destroyed = function(){\n\tSession.set(Meteor.SHOP_ID, false);\n};\n\nTemplate.shopselector.rendered = function(){\n\t// initializes all typeahead instances\n\tMeteor.typeahead.inject();\n\t$(\".twitter-typeahead\").addClass(\"form-control\");\n\t$(\".typeahead\")\n\t.css(\"boxShadow\",\"none\")\n\t.first()\n\t.css(\"opacity\", \"0\");\n\tSession.set(Meteor.NEW_SHOP_KEY, false);\n};\n\nTemplate.shopselector.helpers({\n\tnewShop : function(){\n\t\treturn Session.get(Meteor.NEW_SHOP_KEY);\n\t},\n\tshops: function(query, callback){\n\t\tSession.set(Meteor.NEW_SHOP_KEY, false);\n\t\tcallback(\tShops\n\t\t\t\t\t.find({\n\t\t\t\t\t\t$or : [{\n\t\t\t\t\t\t\tname : {\n\t\t\t\t\t\t\t\t$regex : \".*\"+query.toLowerCase()+\".*\"\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t},{\n\t\t\t\t\t\t\tbrand : {\n\t\t\t\t\t\t\t\t$regex : \".*\"+query.toLowerCase()+\".*\"\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}, {\n\t\t\t\t\t\t\t$where : function(){\n\t\t\t\t\t\t\t\treturn (this.brand+\" - \"+this.name).match(query.toLowerCase());\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}]\n\t\t\t\t\t})\n\t\t\t\t\t.fetch()\n\t\t\t\t\t.map(function(it){\n\t\t\t\t\t\treturn {value: (it.brand||\"\")+\" - \"+it.name};\n\t\t\t\t\t})\n\t\t);\n\t}\n});\n\nTemplate.shopselector.shop = function(template, next){\n\tvar deferred = new $.Deferred();\n\tvalidator(template, function(error, values){\n\t\tif(error){\n\t\t\tdeferred.reject(error);\n\t\t\treturn next(error);\n\t\t}\n\t\tvar shop = Shops.findOne({\n\t\t\t$where : function(){\n\t\t\t\treturn (this.brand+\" - \"+this.name).match(values.name);\n\t\t\t}\n\t\t});\n\t\tif(shop){\n\t\t\tvar result = $.extend({}, values, {_id : shop._id});\n\t\t\tdeferred.resolve(result);\n\t\t\treturn next(null, result);\n\t\t}\n\t\telse{\n\t\t\tsaveShop(template, function(error, shopId){\n\t\t\t\tif(error){ \n\t\t\t\t\tdeferred.reject(error);\n\t\t\t\t\treturn next(error);\n\t\t\t\t}\n\t\t\t\tvar result = $.extend({}, values, {_id : shopId});\n\t\t\t\tdeferred.resolve(result);\n\t\t\t\treturn next(null, result);\n\t\t\t});\t\n\t\t}\n\t});\n\treturn deferred;\n};\n\nvar validator = function(template, next){\n\tvar shopName = template.find(\"#shopName\");\n\tvar contact = template.find(\"#contact\");\n\tvar errors = template.find(\".shopselector .has-error\");\n\t\n\t$(errors)\n\t.removeClass(\"has-error\");\n\n\tvar validation = function(element){\n\t\tif(!element.value){\n\t\t\t$(element)\n\t\t\t.parents(\".form-group\")\n\t\t\t.first()\n\t\t\t.addClass(\"has-error\");\n\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t};\n\tif(contact){\n\t\tif(\tvalidation(shopName) || validation(contact)){\n\t\t\treturn next(new Meteor.Error(\"validation-error\"));\n\t\t}\n\t\treturn next(null, {\n\t\t\tname : shopName.value.toLowerCase(),\n\t\t\tcontacts : [contact.value.toLowerCase()],\n\t\t});\n\t}\n\telse{\n\t\tif(validation(shopName)){\n\t\t\treturn next(new Meteor.Error(\"validation-error\"));\n\t\t}\n\t\treturn next(null, {\n\t\t\tname : shopName.value.toLowerCase()\n\t\t});\n\t}\n};\n\nvar saveShop = function(template, next){\n\tvalidator(template, function(error, values){\n\t\tif(error) return next(error);\n\t\tMeteor.call(\"easyShopCreator\", values, function(error, shopId){\n\t\t\tif(error){\n\t\t\t\treturn next(error);\n\t\t\t}\n\t\t\telse{\n\t\t\t\tvar savShop = template.find(\".saveShop\");\n\t\t\t\t$(savShop)\n\t\t\t\t.removeClass(\"btn-primary\")\n\t\t\t\t.addClass(\"btn-success\");\n\t\t\t\treturn next(null, shopId);\n\t\t\t}\n\t\t});\n\t\tif(Meteor.status().connected === false){\n\t\t\treturn next(null, Shops.findOne({name : values.name})._id);\n\t\t}\n\t});\n};\n\nTemplate.shopselector.events({\n\t\"keyup .typeahead\": function(event) {\n\t\tif(event.keyCode === 13 ||Â event.keyCode === 16 ||Â event.keyCode === 9 ||Â (event.keyCode>=37 && event.keyCode<=40)) return ;\n\t\tif(event.target.value && $(\".tt-suggestions\").length === 0){\n\t\t\tSession.set(Meteor.NEW_SHOP_KEY, true);\n\t\t}\n\t\telse{\n\t\t\tSession.set(Meteor.NEW_SHOP_KEY, false);\n\t\t}\n\t},\n\n\t\"blur .typeahead\": function(event) {\n\t\tvar shop = Shops.findOne({\n\t\t\t$where : function(){\n\t\t\t\treturn ((this.brand||\"\")+\" - \"+this.name) === event.target.value.toLowerCase();\n\t\t\t}\n\t\t});\n\t\tif(shop){\n\t\t\tSession.set(Meteor.SHOP_ID, shop._id);\n\t\t}else{\n\t\t\tSession.set(Meteor.SHOP_ID, false);\n\t\t}\n\t\tif(event.target.value && shop){\n\t\t\tSession.set(Meteor.NEW_SHOP_KEY, false);\n\t\t}\n\t\telse{\n\t\t\tSession.set(Meteor.NEW_SHOP_KEY, true);\n\t\t}\n\t}\n});"]}