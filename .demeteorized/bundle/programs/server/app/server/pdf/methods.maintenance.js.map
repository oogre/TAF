{"version":3,"sources":["meteor://ðŸ’»app/server/pdf/methods.maintenance.js"],"names":[],"mappings":"yBAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,G","file":"/server/pdf/methods.maintenance.js","sourcesContent":["\"use strict\";\n/*global _ : false */\n/*global s : false */\n/*global Npm : false */\n/*global Works : false */\n/*global Wikis : false */\n/*global Shops : false */\n/*global Meteor : false */\n/*global moment : false */\n/*global Workers : false */\n/*global process : false */\n\n\n// meteor run android-device --mobile-server http://ogre.local:3000\n\nMeteor.methods({\n\tmaintenanceToPdf : function(workId){\n\t\tthis.unblock();\n\n\t\tvar Future = Npm.require(\"fibers/future\");\n\t\tvar myFuture = new Future();\n\n\t\tvar currentUser = Meteor.user();\n\t\tvar work = Works.findOne(workId);\n\t\tif(!work){\n\t\t\tconsole.log(\"BUG_1\");\n\t\t\treturn false;\n\t\t}\n\t\tvar shop = Shops.findOne(work.shop._id);\n\t\tif(!shop){\n\t\t\tconsole.log(\"BUG_2\");\n\t\t\treturn false;\n\t\t}\n\n\t\tvar filename = shop.brand.replace(\" \", \"-\") + \"/\" + moment().format(\"YYYY-MM-DD\") + \"-maintenance-\" + workId + \".pdf\";\n\t\t\t\t\t\n\t\tvar dest = process.env.PWD + \"/.uploads/pdf/\";\n\n\t\tvar fs = Npm.require(\"fs\");\t\t\t\n\t\tif (fs.existsSync(dest+filename)) {\n\t\t\treturn \"/upload/pdf/\"+filename;\n\t\t}\n\n\n\t\tvar tasks =\t_(work.modules||[]).chain()\n\t\t\t\t\t.map(function(module){\n\t\t\t\t\t\treturn (module.tasks||[]).map(function(task){\n\t\t\t\t\t\t\treturn task.name;\n\t\t\t\t\t\t})\n\t\t\t\t\t})\n\t\t\t\t\t.flatten()\n\t\t\t\t\t.unique()\n\t\t\t\t\t.sort()\n\t\t\t\t\t.value();\n\t\tvar modules = \t_(work.modules||[]).chain()\n\t\t\t\t\t\t.map(function(module){\n\t\t\t\t\t\t\treturn _([\n\t\t\t\t\t\t\t\tmodule.serial||\"noSerial\",\n\t\t\t\t\t\t\t\ttasks\n\t\t\t\t\t\t\t\t.map(function(task){\n\t\t\t\t\t\t\t\t\ttask = _(module.tasks).chain().where({name: task}).first().value();\n\t\t\t\t\t\t\t\t\tif(_.isObject(task)){\n\t\t\t\t\t\t\t\t\t\tif(task.checked === true) return \"V\";\n\t\t\t\t\t\t\t\t\t\telse if(task.checked == null || task.checked == \"\") return \".\";\n\t\t\t\t\t\t\t\t\t\telse return task.checked\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\telse return \"\";\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t]).flatten();\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.value();\n\t\t\n\t\tHTTP.call(\"GET\", \"http://pdftaf.ogre.be/ogre/maintenane.php\", {\n\t\t\tparams: {\n\t\t\t\tfilename : filename,\n\t\t\t\tdest : dest,\n\t\t\t\ttasks : JSON.stringify(tasks),\n\t\t\t\tmodules : JSON.stringify(modules)\n\t\t\t}\n\t\t}, function (error, result) {\n\t\t\tif(error) myFuture.throw(error);\n\t\t\tif(result.statusCode != 200) myFuture.throw(new Meteor.Error(\"statusCode-\"+result.statusCode));\n\t\t\ttry{\n\t\t\t\tWorks.update({\n\t\t\t\t\t_id:workId\n\t\t\t\t}, {\n\t\t\t\t\t$set : {\n\t\t\t\t\t\tmaintenance : result.data\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t\tmyFuture.return(result.data);\n\t\t\t}catch(e){\n\t\t\t\tmyFuture.throw(new Meteor.Error(\"non_valid_VAT\"));\n\t\t\t}\n\t\t});\n\n\t\t\n\t\treturn myFuture.wait();\n\t}\n});"]}