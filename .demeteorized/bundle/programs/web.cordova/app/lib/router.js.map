{"version":3,"sources":["meteor://üíªapp/lib/router.js"],"names":[],"mappings":"yBAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,I","file":"/lib/router.js","sourcesContent":["/*global _ : true */\n/*global s : true */\n/*global Picts : true */\n/*global Works : true */\n/*global Wikis : true */\n/*global Shops : false */\n/*global Tasks : false */\n/*global Meteor : false */\n/*jshint strict : false */\n/*global Router : false */\n/*global Modules : false */\n/*global Matters : false */\n/*global Workers : false */\n/*global console : false */\n/*global Session : false */\n/*global BaseController : true */\n/*global RouteController : true */\n/*global CleanController : true */\n/*global ApplicationController : true */\n\n\nvar IR_BeforeHooks = {\n\tisLoggedIn: function(router) {\n\t\treturn Meteor.loggingIn() || Meteor.user()\n\t},\n\tresetWiki: function() { \n\t\tSession.set(Meteor.WIKI_CURRENT_KEY, false);\n\t\tSession.set(Meteor.WIKI_OPEN_LIST, false);\n\t\tSession.set(Meteor.WIKI_LIST, false);\n\t},\n\tresetMenu: function() { \n\t\tSession.set(Meteor.FILL_CONTEXT_MENU_KEY, false);\n\t\tSession.set(Meteor.ADD_WORKER, false);\n\t}\n};\n\nBaseController = RouteController.extend({\n\tlayoutTemplate: \"layout\",\n\tbefore: function () {\n\t\tIR_BeforeHooks.resetMenu();\n\t\tthis.next();\n\t},\n\taction: function () {\n\t\tconsole.log(\"this should be overridden!\");\n\t}\n});\n\nApplicationController = BaseController.extend({\n\tbefore: function () {\n\t\tif( ! IR_BeforeHooks.isLoggedIn()){\n\t\t\tthis.redirect(\"signin\");\n\t\t}\n\t\tthis.next();\n\t},\n\taction: function () {\n\t\tconsole.log(\"this should be overridden!\");\n\t}\n});\n\nCleanController = ApplicationController.extend({\n\tbefore: function () {\n\t\tIR_BeforeHooks.resetWiki();\n\t\tthis.next();\n\t},\n});\n\nRouter.configure({\n});\n\n/* HOME */\n\tRouter.route(\"/\", {\n\t\tcontroller : \"CleanController\",\n\t\tname: \"home\",\n\t\taction : function () {\n\t\t\tif(\tShops.find().count()==0 || \n\t\t\t\tUnits.find({}).count() == 0 || \n\t\t\t\t//Works.find({}).count() == 0 || \n\t\t\t\tWorkers.find({}).count() == 0)\n\t\t\t{\n\t\t\t\treturn this.render(\"loadingTemplate\");\n\t\t\t}\n\t\t\tSession.set(Meteor.PAGE_TITLE, \"TAF\");\n\t\t\tthis.render(\"workIndex\");\n\t\t\tif(Meteor.isWorker()){\n\t\t\t\tSession.set(Meteor.FILL_CONTEXT_MENU_KEY, true);\n\t\t\t\tthis.render(\"work-action\", {to : \"action\"}); //contextmenu.action\t\n\t\t\t}\n\t\t}\n\t});\n\n/* SIGN */\n\tRouter.route(\"/signout\", {\n\t\tcontroller : \"CleanController\",\n\t\tname: \"user.signout\",\n\t\taction : function () {\n\t\t\tMeteor.logout();\n\t\t\tthis.redirect(\"/\");\n\t\t}\n\t});\n\n\tRouter.route(\"/signup\", {\n\t\tcontroller : \"BaseController\",\n\t\tname: \"user.signup\",\n\t\taction : function () {\n\t\t\tthis.render(\"signup\");\n\t\t}\n\t});\n\n\tRouter.route(\"/signin\", {\n\t\tcontroller : \"BaseController\",\n\t\tname: \"signin\",\n\t\taction : function () {\n\t\t\tthis.render(\"signin\");\n\t\t}\n\t});\n\n\n/* SHOP */\n\tRouter.route(\"/shop\", {\n\t\tcontroller : \"CleanController\",\n\t\tname: \"shop.index\",\n\t\taction : function () {\n\t\t\tSession.set(Meteor.PAGE_TITLE, \"Liste des Magasins/Clients\");\n\t\t\tthis.render(\"shopindex\");\n\t\t\tif(Meteor.isBoss()){\n\t\t\t\tSession.set(Meteor.FILL_CONTEXT_MENU_KEY, true);\n\t\t\t\tthis.render(\"shopaction\", {to : \"action\"}); //contextmenu.action\n\t\t\t}\n\t\t},\n\t\tdata : function(){\n\t\t\tvar skip = parseInt(this.params.query.skip) || Meteor.indexSkip;\n\t\t\tvar limit = parseInt(this.params.query.limit) || Meteor.indexLimit;\n\t\t\tvar where = this.params.query.where || {};\n\n\t\t\tif(_.isString(where)){\n\t\t\t\twhere = where.toLowerCase();\n\t\t\t\twhere = where.replace(/\\.|\\\\|\\+|\\*|\\?|\\[|\\^|\\]|\\$|\\(|\\)|\\{|\\}|\\=|\\!|\\>|\\||\\:|\\-/g, \"\");\n\t\t\t\twhere = {\n\t\t\t\t\t$or : [{\n\t\t\t\t\t\tname : {\n\t\t\t\t\t\t\t$regex : \".*\"+where+\".*\"\n\t\t\t\t\t\t}\n\t\t\t\t\t}, {\n\t\t\t\t\t\tbrand : {\n\t\t\t\t\t\t\t$regex : \".*\"+where+\".*\"\n\t\t\t\t\t\t}\n\t\t\t\t\t}]\n\t\t\t\t};\n\t\t\t}\n\t\t\t\n\t\t\treturn {\n\t\t\t\tshops : Shops.find(where,{\n\t\t\t\t\tskip: skip,\n\t\t\t\t\tlimit: limit,\n\t\t\t\t\tsort : {\n\t\t\t\t\t\tbrand : 1\n\t\t\t\t\t} \n\t\t\t\t}),\n\t\t\t\tcount : Shops.find(where).count(),\n\t\t\t\twhere : this.params.query.where||\"\",\n\t\t\t\tlimit : limit,\n\t\t\t\tskip : skip\n\t\t\t};\n\t\t}\n\t});\n\n\tRouter.route(\"/shop/new\", {\n\t\tcontroller : \"ApplicationController\",\n\t\tname: \"shop.new\",\n\t\taction : function () {\n\t\t\tSession.set(Meteor.PAGE_TITLE, \"Cr√©er un nouveau Magasins/Clients\");\t\n\t\t\tthis.render(\"shopnew\");\n\t\t}\n\t});\n\n\tRouter.route(\"/shop/edit/:shopId\", {\n\t\tcontroller : \"CleanController\",\n\t\tname: \"shop.edit\",\n\t\tdata : function(){\n\t\t\treturn Shops.findOne(this.params.shopId); \n\t\t},\n\t\taction : function () {\n\t\t\tvar data = this.data();\n\t\t\tif(data){\n\t\t\t\tSession.set(Meteor.PAGE_TITLE, \"Edition \"+s.capitalize(data.name)+\" - \"+s.capitalize(data.brand));\t\n\t\t\t}\n\t\t\tthis.render(\"shopedit\");\n\t\t\tif(Meteor.isBoss()){\n\t\t\t\tSession.set(Meteor.FILL_CONTEXT_MENU_KEY, true);\n\t\t\t\tthis.render(\"shopeditaction\", {to : \"action\"}); //contextmenu.action\n\t\t\t}\n\t\t}\n\t});\n\n\tRouter.route(\"/shop/:shopId\", {\n\t\tcontroller : \"ApplicationController\",\n\t\tname: \"shop.view\",\n\t\tdata : function(){\n\t\t\tvar date = this.params.query.date || moment();\n\t\t\tvar start = moment(date).subtract(1, \"month\").toISOString();\n\t\t\tvar stop = moment(date).add(1, \"month\").toISOString();\n\t\t\twhere = {\n\t\t\t\t\"shop._id\" : this.params.shopId, \n\t\t\t\trdv : {\n\t\t\t\t\t$gte: start,\n\t\t\t\t\t$lte: stop\n\t\t\t\t}\n\t\t\t};\n\t\t\tvar tmp = \t_\n\t\t\t\t\t\t.chain(\n\t\t\t\t\t\t\tWorks\n\t\t\t\t\t\t\t.find(where, {\n\t\t\t\t\t\t\t\tsort : {\n\t\t\t\t\t\t\t\t\trdv : -1\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t.fetch()\n\t\t\t\t\t\t)\n\t\t\t\t\t\t.map(function(work){\n\t\t\t\t\t\t\twork.rdv = moment(work.rdv).format(\"DD/MM/YY HH:mm\");\n\t\t\t\t\t\t\treturn work;\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.groupBy(function(work){\n\t\t\t\t\t\t\treturn work.end;\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.value();\n\t\t\tvar unfinished = tmp.undefined || [];\n\t\t\tvar torun = [];\n\t\t\tunfinished = \tunfinished\n\t\t\t\t\t\t\t.map(function(work){\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\tif( _\n\t\t\t\t\t\t\t\t\t.chain(work.schedular)\n\t\t\t\t\t\t\t\t\t.keys()\n\t\t\t\t\t\t\t\t\t.map(function(worker){\n\t\t\t\t\t\t\t\t\t\treturn  work.schedular[worker].length > 0;\n\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t\t.some()\n\t\t\t\t\t\t\t\t\t.value()\n\t\t\t\t\t\t\t\t){\n\t\t\t\t\t\t\t\t\treturn work;\n\t\t\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\t\t\ttorun.push(work);\n\t\t\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t});\n\t\t\tunfinished = _.compact(unfinished)\n\n\t\t\tdelete tmp.undefined;\t\t\n\t\t\treturn{\n\t\t\t\tworks : {\n\t\t\t\t\tcount : Works.find(where).count(),\n\t\t\t\t\tdate : date,\n\t\t\t\t\ttorun : torun.reverse(),\n\t\t\t\t\tunfinished : unfinished,\n\t\t\t\t\tfinished : \t_\n\t\t\t\t\t\t\t\t.chain(tmp)\n\t\t\t\t\t\t\t\t.values()\n\t\t\t\t\t\t\t\t.flatten()\n\t\t\t\t\t\t\t\t.map(function(work){\n\t\t\t\t\t\t\t\t\twork.depannage = work.type == \"d√©pannage\";\n\t\t\t\t\t\t\t\t\twork.installation = work.type == \"installation\";\n\t\t\t\t\t\t\t\t\twork.entretien = work.type == \"maintenance\";\n\t\t\t\t\t\t\t\t\treturn work;\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t.value()\n\t\t\t\t},\n\t\t\t\tshop : Shops.findOne(this.params.shopId)\n\t\t\t};\n\t\t},\n\t\taction : function () {\n\t\t\tvar data = this.data();\n\t\t\tif(data){\n\t\t\t\tSession.set(Meteor.PAGE_TITLE, s.capitalize(data.shop.name)+\" - \"+s.capitalize(data.shop.brand));\t\n\t\t\t}\n\t\t\tthis.render(\"shopview\");\n\t\t}\n\t});\n\n\tRouter.route(\"/shop/modules/:shopId\", {\n\t\tcontroller : \"ApplicationController\",\n\t\tname: \"shop.modules\",\n\t\tdata : function(){\n\t\t\tvar shopId = this.params.shopId;\n\t\t\treturn {\n\t\t\t\tshop : Shops.findOne(shopId),\n\t\t\t\tmodules : \tModules\n\t\t\t\t\t\t\t.find({}, {\n\t\t\t\t\t\t\t\tsort : {\n\t\t\t\t\t\t\t\t\ttype : 1\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t.fetch()\n\t\t\t\t\t\t\t.map(function(module){\n\t\t\t\t\t\t\t\tmodule.shopId = shopId;\n\t\t\t\t\t\t\t\treturn module;\n\t\t\t\t\t\t\t})\n\t\t\t};\n\t\t},\n\t\taction : function () {\n\t\t\tvar data = this.data();\n\t\t\tif(data && data.shop){\n\t\t\t\tSession.set(Meteor.PAGE_TITLE, \"Edition des modules de \"+s.capitalize(data.shop.name)+\" - \"+s.capitalize(data.shop.brand));\t\n\t\t\t}\n\t\t\tthis.render(\"shopmodules\");\n\t\t}\n\t});\n\n/* MODULES */\n\tRouter.route(\"/module/new\", {\n\t\tcontroller : \"ApplicationController\",\n\t\tname: \"module.new\",\n\t\taction : function () {\n\t\t\tSession.set(Meteor.PAGE_TITLE, \"Nouveau Module\");\n\t\t\tthis.render(\"modulenew\");\n\t\t}\n\t});\n\n\tRouter.route(\"/module/edit/:moduleId\", {\n\t\tcontroller : \"ApplicationController\",\n\t\tname: \"module.edit\",\n\t\tdata : function(){\n\t\t\treturn Modules.findOne(this.params.moduleId);\n\t\t},\n\t\taction : function () {\n\t\t\tvar data = this.data();\n\t\t\tif(data){\n\t\t\t\tSession.set(Meteor.PAGE_TITLE, \"Edition du module : \"+s.capitalize(data.name)+\" - \"+s.capitalize(data.type));\t\n\t\t\t}\n\t\t\tthis.render(\"moduleedit\");\n\t\t}\n\t});\n\n\tRouter.route(\"/module\", {\n\t\tcontroller : \"CleanController\",\n\t\tname: \"module.index\",\n\t\tdata : function(){\n\t\t\treturn {\n\t\t\t\tmodules : \t_\n\t\t\t\t\t\t\t.chain(Modules.find().fetch())\n\t\t\t\t\t\t\t.groupBy(function(module){\n\t\t\t\t\t\t\t\treturn module.type;\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t.map(function(val,key){\n\t\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\t\ttype: key, \n\t\t\t\t\t\t\t\t\tmodules: val\n\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t.sortBy(function(Modules){\n\t\t\t\t\t\t\t\treturn Modules.type;\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t.value()\n\t\t\t};\n\t\t},\n\t\taction : function () {\n\t\t\tSession.set(Meteor.PAGE_TITLE, \"Liste des Modules\");\n\t\t\tthis.render(\"moduleindex\");\n\t\t\tif(Meteor.isBoss()){\n\t\t\t\tSession.set(Meteor.FILL_CONTEXT_MENU_KEY, true);\n\t\t\t\tthis.render(\"moduleaction\", {to : \"action\"}); //contextmenu.action\n\t\t\t}\n\t\t}\n\t});\n\n/* TASKS */\n\tRouter.route(\"/task/new\", {\n\t\tcontroller : \"ApplicationController\",\n\t\tname: \"task.new\",\n\t\taction : function () {\n\t\t\tSession.set(Meteor.PAGE_TITLE, \"Nouvelle t√¢che\");\n\t\t\tthis.render(\"tasknew\");\n\t\t}\n\t});\n\n\tRouter.route(\"/task\", {\n\t\tcontroller : \"CleanController\",\n\t\tname: \"task.index\",\n\t\tdata : function(){\n\t\t\treturn {\n\t\t\t\ttasks : _\n\t\t\t\t\t\t.chain(Tasks.find().fetch())\n\t\t\t\t\t\t.groupBy(function(task){\n\t\t\t\t\t\t\treturn task.moduletype;\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.map(function(tasks){\n\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\tcategory : tasks[0].moduletype || \"-\",\n\t\t\t\t\t\t\t\ttasks : tasks\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.sortBy(function(task){\n\t\t\t\t\t\t\treturn task.category;\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.value()\n\t\t\t};\n\t\t},\n\t\taction : function () {\n\t\t\tSession.set(Meteor.PAGE_TITLE, \"Liste des t√¢ches\");\n\t\t\tthis.render(\"taskindex\");\n\t\t\tif(Meteor.isBoss()){\n\t\t\t\tSession.set(Meteor.FILL_CONTEXT_MENU_KEY, true);\n\t\t\t\tthis.render(\"taskaction\", {to : \"action\"}); //contextmenu.action\n\t\t\t}\n\t\t}\n\t});\n\n\tRouter.route(\"/task/edit/:taskId\", {\n\t\tcontroller : \"ApplicationController\",\n\t\tname: \"task.edit\",\n\t\tdata : function(){\n\t\t\treturn Tasks.findOne(this.params.taskId);\n\t\t},\n\t\taction : function () {\n\t\t\tvar data = this.data();\n\t\t\tif(data){\n\t\t\t\tSession.set(Meteor.TASK_INPUT_TEXT, data.value);\n\t\t\t\tSession.set(Meteor.PAGE_TITLE, \"Edition de la t√¢che : \"+s.capitalize(data.name));\n\t\t\t}\n\t\t\tthis.render(\"taskedit\");\n\t\t}\n\t});\n\n\n/* WORKER */\n\tRouter.route(\"/worker\", {\n\t\tcontroller : \"CleanController\",\n\t\tname: \"worker.index\",\n\t\taction : function () {\n\t\t\tSession.set(Meteor.PAGE_TITLE, \"List des travailleurs\");\n\t\t\tthis.render(\"workerindex\");\n\t\t\tif(Meteor.isBoss()){\n\t\t\t\tSession.set(Meteor.FILL_CONTEXT_MENU_KEY, true);\n\t\t\t\tthis.render(\"workeraction\", {to : \"action\"}); //contextmenu.action\n\t\t\t}\n\t\t},\n\t\tdata : function(){\n\t\t\treturn {\n\t\t\t\tworker_ids : Workers.find().fetch().map(function(worker){return worker._id;})\n\t\t\t};\n\t\t}\n\t});\n\n\tRouter.route(\"/worker/new\", {\n\t\tcontroller : \"ApplicationController\",\n\t\tname: \"user.new\",\n\t\tdata : function(){\n\t\t\treturn this.params;\n\t\t},\n\t\taction : function () {\n\t\t\tSession.set(Meteor.PAGE_TITLE, \"Nouveau travailleurs\");\n\t\t\tthis.render(\"workernew\");\n\t\t}\n\t});\n\n\tRouter.route(\"/worker/edit/:workerId\", {\n\t\tcontroller : \"CleanController\",\n\t\tname: \"user.edit\",\n\t\tdata : function(){\n\t\t\treturn Workers.findOne(this.params.workerId); \n\t\t},\n\t\taction : function () {\n\t\t\tvar data = this.data();\n\t\t\tif(data){\n\t\t\t\tSession.set(Meteor.PAGE_TITLE, \"Editer la fiche de : \"+s.capitalize(data.profile.firstname)+\" \"+s.capitalize(data.profile.lastname));\t\n\t\t\t}\n\t\t\tthis.render(\"workeredit\");\n\t\t}\t\n\t});\n\n\n\tRouter.route(\"/worker/:workerId\", {\n\t\tcontroller : \"CleanController\",\n\t\tname: \"user.view\",\n\t\tdata : function(){\n\t\t\treturn Workers.findOne(this.params.workerId); \n\t\t},\n\t\taction : function () {\n\t\t\tvar data = this.data();\n\t\t\tif(data){\n\t\t\t\tSession.set(Meteor.PAGE_TITLE, s.capitalize(data.profile.firstname)+\" \"+s.capitalize(data.profile.lastname));\t\n\t\t\t}\n\t\t\tthis.render(\"workerview\");\n\t\t}\t\n\t});\n\n\n/* WORK */\n\tRouter.route(\"/work/new\", {\n\t\tcontroller : \"ApplicationController\",\n\t\tname: \"work.new\",\n\t\tdata : function(){\n\t\t\treturn this.params;\n\t\t},\n\t\taction : function () {\n\t\t\tSession.set(Meteor.PAGE_TITLE, \"Nouvelle fiche de travail : \"+decodeURIComponent(this.request.url.split(\"#\")[1]));\t\n\t\t\tthis.render(\"work-new\");\n\t\t}\n\t});\n\n\tRouter.route(\"/work/:workId\", {\n\t\tcontroller : \"ApplicationController\",\n\t\tname: \"work.show\",\n\t\tdata : function(){\n\t\t\tvar work = Works.findOne(this.params.workId);\n\t\t\tif(!work){\n\t\t\t\treturn;\n\t\t\t}\n\t\t\twork.pictures = Picts.find({\n\t\t\t\t\t\t\t\t_id : {\n\t\t\t\t\t\t\t\t\t$in : work.pictures||[]\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t.fetch()\n\t\t\t\t\t\t\t.map(function(pict){\n\t\t\t\t\t\t\t\tif(_.isString(pict.data)) return pict.data;\n\t\t\t\t\t\t\t\treturn Meteor.pictureServer+\"/\"+pict.data.path;\n\t\t\t\t\t\t\t});\n\t\t\twork.wikis = Wikis.find({\n\t\t\t\t\t\t\t_id : {\n\t\t\t\t\t\t\t\t$in : work.wikis||[]\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}, {\n\t\t\t\t\t\t\tsort :{\n\t\t\t\t\t\t\t\tcreatedAt : -1\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\treturn work; \n\t\t},\n\t\taction : function () {\n\t\t\tvar data = this.data();\n\t\t\tif(data){\n\t\t\t\tSession.set(Meteor.PAGE_TITLE, s.capitalize(data.type)+\" chez \"+s.capitalize(data.shop.name));\t\n\t\t\t}\n\t\t\tthis.render(\"work-view\");\n\t\t\tif(Meteor.isChief()){\n\t\t\t\tSession.set(Meteor.FILL_CONTEXT_MENU_KEY, true);\n\t\t\t\tthis.render(\"work-viewaction\", {to : \"action\"}); //contextmenu.action\n\t\t\t}\n\t\t}\n\t});\n\n/* MATTERS */\n\tRouter.route(\"/matter/new\", {\n\t\tcontroller : \"ApplicationController\",\n\t\tname: \"matter.new\",\n\t\taction : function () {\n\t\t\tSession.set(Meteor.PAGE_TITLE, \"Nouveau Mat√©riel\");\n\t\t\tthis.render(\"matternew\");\n\t\t}\n\t});\n\n\tRouter.route(\"/matter/edit/:matterId\", {\n\t\tcontroller : \"ApplicationController\",\n\t\tname: \"matter.edit\",\n\t\tdata : function(){\n\t\t\treturn Matters.findOne(this.params.matterId);\n\t\t},\n\t\taction : function () {\n\t\t\tvar data = this.data();\n\t\t\tif(data){\n\t\t\t\tSession.set(Meteor.PAGE_TITLE, \"Edition du mat√©rial : \"+s.capitalize(data.name));\n\t\t\t}\n\t\t\tthis.render(\"matteredit\");\n\t\t}\n\t});\n\n\tRouter.route(\"/matter\", {\n\t\tcontroller : \"CleanController\",\n\t\tname: \"matter.index\",\n\t\tdata : function(){\n\t\t\treturn {\n\t\t\t\tmatters : Matters\n\t\t\t\t\t\t\t.find({\n\n\t\t\t\t\t\t\t},{\n\t\t\t\t\t\t\t\tsort : {\n\t\t\t\t\t\t\t\t\tname : 1\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}).fetch()\n\t\t\t};\n\t\t},\n\t\taction : function () {\n\t\t\tSession.set(Meteor.PAGE_TITLE, \"Liste des Mat√©riels\");\n\t\t\tthis.render(\"matterindex\");\n\t\t\tif(Meteor.isBoss()){\n\t\t\t\tSession.set(Meteor.FILL_CONTEXT_MENU_KEY, true);\n\t\t\t\tthis.render(\"matteraction\", {to : \"action\"}); //contextmenu.action\n\t\t\t}\n\t\t}\n\t});"]}