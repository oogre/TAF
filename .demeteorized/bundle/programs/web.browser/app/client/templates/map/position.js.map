{"version":3,"sources":["meteor://ðŸ’»app/client/templates/map/position.js"],"names":[],"mappings":"yBAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"/client/templates/map/position.js","sourcesContent":["\"use strict\";\n/*global _ : false */\n/*global $ : false */\n/*global google : false */\n/*global Meteor : false */\n/*global Tracker : false */\n/*global Session : false */\n/*global Template : false */\n/*global GoogleMaps : false */\n\n\nvar directionsDisplay;\nvar markers = {};\nvar center;\nvar zoom;\nvar map ;\n\nvar initRouter = function(destination){\n\tMeteor.getLocation(function(error, origin){\n\t\tif(error) return console.log(error);\n\t\tMeteor.routing(origin, destination, function(error, route){\n\t\t\tif(error) return console.log(error);\n\t\t\tSession.set(Meteor.MAP_LARGE, true);\n\t\t\tdirectionsDisplay = new google.maps.DirectionsRenderer();\n\t\t\tdirectionsDisplay.setMap(map);\n\t\t\tdirectionsDisplay.setDirections(route);\n\t\t\tvar distance = route.routes[0].legs[0].distance.text;\n\t\t\tvar duration = route.routes[0].legs[0].duration.text;\n\t\t\tSession.set(Meteor.MAP_ROUTING_DURATION, distance+\" (\"+duration+\")\");\n\t\t\tmarkers.myloc = new google.maps.Marker({\n\t\t\t\tclickable: false,\n\t\t\t\ticon: new google.maps.MarkerImage(\"/images/mobileimgs2.png\",\n\t\t\t\t\t\t\t\t\t\t\t\t\tnew google.maps.Size(22,22),\n\t\t\t\t\t\t\t\t\t\t\t\t\tnew google.maps.Point(0,18),\n\t\t\t\t\t\t\t\t\t\t\t\t\tnew google.maps.Point(11,11)),\n\t\t\t\tshadow: null,\n\t\t\t\tzIndex: 999,\n\t\t\t\tmap: map\n\t\t\t});\n\t\t\tSession.set(Meteor.MAP_ROUTING, false);\n\t\t\tzoom = map.getZoom();\n\t\t\tcenter = map.getCenter();\n\t\t});\n\t});\n};\n\nvar startRouting = function(){\n\tvar flagZoom = true;\n\treturn Meteor.watchLocation(function(error, location){\n\t\tif(error)return;\n\t\tmarkers.myloc.setPosition(location);\n\t\tcenter = location;\n\t\tif(Session.get(Meteor.MAP_FOLLOW_CENTER)){\n\t\t\tif(flagZoom){\n\t\t\t\tzoom = 18;\n\t\t\t\tflagZoom = false;\n\t\t\t\tmap.setZoom(zoom);\n\t\t\t}\n\t\t\tmap.setCenter(center);\n\t\t}\n\t});\n};\n\nTemplate.position.destroyed = function(){\n\tif(_.isNumber(Session.get(Meteor.MAP_ROUTING))){\n\t\tnavigator.geolocation.clearWatch(Session.get(Meteor.MAP_ROUTING));\n\t\tSession.set(Meteor.MAP_ROUTING, null);\n\t}\n\tSession.set(Meteor.MAP_LARGE, false);\n\tSession.set(Meteor.MAP_FOLLOW_CENTER, true);\n\tSession.set(Meteor.MAP_READY, false);\n\tSession.set(Meteor.MAP_ROUTING_DURATION, false);\n};\n\nTemplate.position.rendered = function(){\n\tvar shop = this.data;\n\tcenter = shop.location;\n\tzoom = 15;\n\tif(_.isObject(center)){\n\t\tGoogleMaps.init(\n\t\t{\t\n\t\t\t\"sensor\": true,\n\t\t\t//\"key\": Meteor.google.key,\n\t\t\t\"language\": \"fr\"\n\t\t},\n\t\tfunction(){\n\t\t\tvar mapOptions = {\n\t\t\t\tcenter: center,\n\t\t\t\tzoom: zoom\n\t\t\t};\n\t\t\tmap = new google.maps.Map($(\"#map-canvas\")[0], mapOptions);\n\t\t\t\n\t\t\tgoogle.maps.event.addListener(map,\"drag\",function() {\n\t\t\t\tSession.set(Meteor.MAP_FOLLOW_CENTER, false);\n\t\t\t});\n\t\t\tgoogle.maps.event.addListener(map,\"idle\",function() {\n\t\t\t\tSession.set(Meteor.MAP_READY, true);\n\t\t\t});\n\t\t\t\n\t\t\tmarkers.shop = new google.maps.Marker({\n\t\t\t\tposition: center,\n\t\t\t\tmap: map,\n\t\t\t\ttitle:\"\"\n\t\t\t});\n\n\t\t\tvar resize = function(isLArge, followCenter){\n\t\t\t\tvar canvas = $(\"#map-canvas\");\n\t\t\t\tvar width = canvas.parent().width();\n\t\t\t\tvar height = isLArge ? $(window).height()-canvas.offset().top : 150;\n\t\t\t\tcanvas.width(width);\n\t\t\t\tcanvas.height(height);\n\t\t\t\tgoogle.maps.event.trigger(map, \"resize\");\n\t\t\t\tif(followCenter){\n\t\t\t\t\tif(map.getZoom()!== zoom){\n\t\t\t\t\t\tmap.setZoom(zoom);\n\t\t\t\t\t}\n\t\t\t\t\tmap.setCenter(center);\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tTracker.autorun(function () {\n\t\t\t\tresize(Session.get(Meteor.MAP_LARGE), Session.get(Meteor.MAP_FOLLOW_CENTER));\n\t\t\t});\n\n\t\t\t$(window).resize(function() {\n\t\t\t\tresize(Session.get(Meteor.MAP_LARGE), Session.get(Meteor.MAP_FOLLOW_CENTER));\n\t\t\t});\n\n\t\t\tconsole.log(shop.location);\n\t\t\tif(!shop.timeDist){\n\t\t\t\tMeteor.routing(Meteor.QG.location, shop.location, function(error, route){\n\t\t\t\t\tif(error) return console.log(error);\n\t\t\t\t\tMeteor.call(\"shopUpdateTimeDist\", shop._id, route.routes[0].legs[0].duration.value);\n\t\t\t\t});\t\n\t\t\t}\n\t\t});\n\t}\n};\n\nTemplate.position.helpers({\n\tisLarge : function(){\n\t\treturn Session.get(Meteor.MAP_LARGE);\n\t},\n\tconnected : function(){\n\t\treturn Meteor.status().connected;\n\t},\n\troutingReady : function(){\n\t\treturn Session.get(Meteor.MAP_ROUTING) === false;\n\t},\n\tfollowCenter : function(){\n\t\treturn Session.get(Meteor.MAP_FOLLOW_CENTER);\n\t},\n\tmapReady : function(){\n\t\treturn Session.get(Meteor.MAP_READY);\n\t},\n\tduration : function(){\n\t\treturn Session.get(Meteor.MAP_ROUTING_DURATION);\t\n\t}\n});\n\nTemplate.position.events({\n\t\"click .mapSizer\" : function(){\n\t\tSession.set(Meteor.MAP_LARGE, !Session.get(Meteor.MAP_LARGE));\n\t\treturn false;\n\t},\n\t\"click .mapRouter\" : function(){\n\t\tif(_.isNumber(Session.get(Meteor.MAP_ROUTING))){\n\t\t\tnavigator.geolocation.clearWatch(Session.get(Meteor.MAP_ROUTING));\n\t\t\tSession.set(Meteor.MAP_ROUTING, false);\n\t\t}\n\t\tinitRouter(this);\n\t\treturn false;\n\t},\n\t\"click .mapResume\" : function(){\n\t\tSession.set(Meteor.MAP_FOLLOW_CENTER, true);\n\t\treturn false;\n\t},\n\t\"click .mapRouting\" : function(){\n\t\tif(_.isNumber(Session.get(Meteor.MAP_ROUTING))){\n\t\t\tnavigator.geolocation.clearWatch(Session.get(Meteor.MAP_ROUTING));\n\t\t\tSession.set(Meteor.MAP_ROUTING, false);\n\t\t}\n\t\tSession.set(Meteor.MAP_ROUTING, startRouting());\n\t\treturn false;\n\t}\n});\n"]}